<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>  

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([6.9271, 80.2741], 13); // Initial position

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Object to store train markers
    const trainMarkers = {};
    
    // Define the path layer
    const pathLayer = L.geoJSON().addTo(map);

    // Function to fetch and display the latest train data
    function updateTrainData() {
      fetch('http://localhost:3000/trains')
        .then(response => response.json())
        .then(trains => {
          // Fetch and display the train routes
          fetch('http://localhost:3000/routes')
            .then(response => response.json())
            .then(routes => {
              console.log('Fetched routes:', routes); // Log the fetched routes data

              // Clear existing paths
              pathLayer.clearLayers();

              // Convert routes to GeoJSON format and add to map
              routes.forEach(route => {
                console.log('Processing route:', route); // Log each route

                if (route.hasActiveTrain) {
                  try {
                    // Convert to GeoJSON format
                    const geoJSONFeature = {
                      type: 'Feature',
                      geometry: {
                        type: 'LineString',
                        coordinates: route.coordinates.map(coord => [coord[0], coord[1]]) // [longitude, latitude]
                      },
                      properties: {
                        color: route.color || 'blue'
                      }
                    };

                    L.geoJSON(geoJSONFeature, {
                      style: { color: geoJSONFeature.properties.color }
                    }).addTo(pathLayer);
                  } catch (error) {
                    console.error('Invalid GeoJSON object:', route, error); // Log errors if any
                  }
                }
              });
            })
            .catch(error => console.error('Error fetching route data:', error));

          // Process train data
          trains.forEach(train => {
            const { id, name, latitude, longitude } = train;

            // Check if the marker already exists
            if (trainMarkers[id]) {
              // Update existing marker
              trainMarkers[id].setLatLng([latitude, longitude])
                .setPopupContent(`<b>${name}</b>`);
            } else {
              // Add a new marker
              trainMarkers[id] = L.marker([latitude, longitude])
                .bindPopup(`<b>${name}</b>`)
                .addTo(map);
            }
          });
        })
        .catch(error => console.error('Error fetching train data:', error));
    }

    // Update train data every 10 seconds
    setInterval(updateTrainData, 10000);

    // Initial data load
    updateTrainData();
  </script>
</body>
</html>
